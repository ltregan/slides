<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<title>Cloud Native OCI - MuShop</title>
	
	<link rel="stylesheet" href="/css/reset.css">
	<link rel="stylesheet" href="/css/reveal.css">
	<link rel="stylesheet" href="/css/theme/mu.css">

	<!-- Theme used for syntax highlighting of code -->
	<link rel="stylesheet" href="/lib/css/monokai.css">

	<!-- Printing and PDF exports -->
	<script>
		var link = document.createElement('link');
		link.rel = 'stylesheet';
		link.type = 'text/css';
		link.href = window.location.search.match(/print-pdf/gi) ? '/css/print/pdf.css' : '/css/print/paper.css';
		document.getElementsByTagName('head')[0].appendChild(link);
	</script>
</head>

<body>
	<div class="reveal">
		<div class="slides">
			<!-- title -->
			<section id="home">
				<!-- landing -->
				<section id="home-title">
					<h1>Cloud Native OCI</h1>
					<h2>Shipping and Stream Services</h2>
					<div class="mu-flex mu-flex-center mu-flex-middle mu-margin">
						<img height="100" class="plain no-margin" data-src="/images/tech/oci.png" alt="Oracle Cloud Infrastructure" />
						<span>+</span>
						<img height="80" class="plain no-margin" data-src="/images/logo.png" alt="MuShop" />
					</div>
					<hr/>
					<small>Created with ❤ by <a href="#contributors">Oracle A-Team</a></small>
				</section>

				<!-- TOC -->
				<section id="toc">
					<h2>Table of Contents</h2>
					<ul class="plain">
						<!-- add a line for each <section id="slideId">...</section>  -->
						<li><a href="#home">Home</a></li>
						<li><a href="#lab">Lab Overview</a></li>
					</ul>
				</section>

				<!-- Contributors -->
				<section id="contributors">
					<h2>Primary Contributors</h2>
					<div class="mu-flex mu-flex-center mu-small mu-left mu-gutter">
						<div>
							<div>Adao Oliveira Junior</div>
							<div>Jeevan Joseph</div>
							<div>Julio Camara</div>
						</div>
						<div>
							<div>Matt Vander Vliet</div>
							<div>Sherwood Zern</div>
							<div>Sumit Kumar</div>
						</div>
					</div>
				</section>
			</section>

			<!-- Shipping/Streams App -->
			<section id="shippingApp">
				<h3>Shipping Microservice</h3>
				<div class="mu-flex mu-flex-middle mu-margin">
					<div class="mu-svc">
						<img data-src="/images/tech/java.png" /> Order
					</div>
					<div class="mu-flex-connector arrow"></div>
					<div class="mu-svc">
						<img data-src="/images/tech/java.png" /> Shipping
					</div>
					<div class="mu-flex-connector arrow"></div>
					<div class="mu-svc">
						<img data-src="/images/tech/docker.svg" /> RabbitMQ
					</div>
					<div class="mu-flex-connector arrow"></div>
					<div class="mu-svc">
						<img data-src="/images/tech/java.png" /> Queue
					</div>
					<div class="mu-flex-connector arrow"></div>
					<div class="mu-svc">
						<img data-src="/images/streams/shipping-2.png" /> Fulfillment
					</div>
				</div>
				<div class="fragment mu-flex mu-flex-middle mu-margin">
					<div class="mu-svc">
						<img data-src="/images/tech/java.png" /> Order
					</div>
					<div class="mu-flex-connector arrow"></div>
					<div class="mu-svc">
						<img data-src="/images/tech/java.png" /> Shipping
					</div>
					<div class="mu-flex-connector arrow"></div>
					<div class="mu-svc">
						<img data-src="/images/tech/streaming.svg" /> OSS
					</div>
					<div class="mu-flex-connector arrow"></div>
					<div class="mu-svc">
						<img data-src="/images/tech/java.png" /> Stream
					</div>
					<div class="mu-flex-connector arrow"></div>
					<div class="mu-svc">
						<img data-src="/images/streams/shipping-2.png" /> Fulfillment
					</div>
				</div>
			</section>

			<!-- Streams -->
			<section id="oss">
				<h2>Oracle Streaming Service</h2>
				<ul>
					<li>What is OSS?</li>
					<li>Use cases</li>
					<li>Concepts</li>
					<li>How it works</li>
					<li>Limits</li>
				</ul>
			</section>
			<section>
				<h2>What is OSS?</h2>
				<ul>
					<li>The OCI Streaming Service provides a fully managed, scalable, and durable storage solution for ingesting continuous, high-volume streams of data that you can consume and process in real time</li>
					<li>OSS is a distributed even-log</li>
					<li>Messages are written to partitions and can be referenced via partition/offset</li>
				</ul>
				<img class="plain" data-src="/images/streams/stream1.png" alt="Producer -> Stream -> Consumer"/>
			</section>
			<section>
				<h2>Use cases</h2>
				<ul>
					<li>Metric and log ingestion</li>
					<div class=fragment><li>Messaging</li></div>
					<div class=fragment><li>Web/Module activity data ingestion</li></div>
					<div class=fragment><li>Infrastructure and apps event processing</li></div>
				</ul>
				<img class="plain" data-src="/images/streams/stream1.png" alt="Producer -> Stream -> Consumer"/>
			</section>
			<section>
				<h2>Concepts</h2>
				<ul>
					<li>Stream: a partitioned, append-only log of messages</li>
					<div class=fragment><li>Message: base64-encoded record that is published to the stream</li></div>
					<div class=fragment><li>Offset: the location of a message within a partition.</li></div>
				</ul>
				<img class="plain" data-src="/images/streams/stream.png" alt="Producer -> Partitions -> Consumer"/>
			</section>
			<section>
				<h2>Concepts</h2>
				<ul>
					<li>Partition: a section of a stream. It allows you to distribute a stream by splitting messages across multiple nodes. Each partition can be placed on a separate machine to allow for multiple consumers to read from a stream in parallel.</li>
				</ul>
				<img class="plain" data-src="/images/streams/3partitions.png" alt="Example of 3 partitions"/>
			</section>
			<section>
				<h2>Concepts</h2>
				<ul>
					<li>Cursor: a pointer to a location (offset or time) in a stream.</li>
				</ul>
				<img class="plain" data-src="/images/streams/cursor.png" alt="Cursor"/>
			</section>
			<section>
					<h2>Concepts</h2>
					<h3>Cursor Types</h3>
					<div>
						<ul>
							<li>TRIM_HORIZON</li>
							<li>AT_OFFSET</li>
							<li>AFTER_OFFSET</li>
							<li>AT_TIME</li>
							<li>LATEST</li>
						</ul>
					</div>
					<img class="plain" data-src="/images/streams/cursor.png" alt="Producer"/>
			</section>
			<section>
					<h2>Concepts</h2>
					<h3>Cursor Type: TRIM_HORIZON</h3>
					<img class="plain" data-src="/images/streams/trim_horizon.png" alt="trim_horizon cursor"/>
			</section>
			<section>
					<h2>Concepts</h2>
					<h3>Cursor Type: AT_OFFSET</h3>
					<img class="plain" data-src="/images/streams/at_offset.png" alt="at_offset cursor"/>
			</section>
			<section>
					<h2>Concepts</h2>
					<h3>Cursor Type: AFTER_OFFSET</h3>
					<img class="plain" data-src="/images/streams/after_offset.png" alt="after_offset cursor"/>
			</section>
			<section>
					<h2>Concepts</h2>
					<h3>Cursor Type: AT_TIME</h3>
					Consume after given time. Timestamp of the message >= supplied time.
					<img class="plain" data-src="/images/streams/at_time.png" alt="at_time cursor"/>
			</section>
			<section>
					<h2>Concepts</h2>
					<h3>Cursor Type: LATEST</h3>
					<p>Consume messages published after the cursor creation.</p>
					<img class="plain" data-src="/images/streams/latest.png" alt="latest cursor"/>
			</section>
			<section>
				<h2>Concepts</h2>
				<ul>
					<li>Producer: an entity that writes/publishes messages to a stream.</li>
				</ul>
				<img class="plain" data-src="/images/streams/producer.png" alt="Producer"/>
			</section>
			<section>
				<h2>Concepts</h2>
				<ul>
					<li>Consumer: an entity that reads messages from one or more streams.</li>
				</ul>
				<img class="plain" data-src="/images/streams/consumer.png" alt="Producer"/>
			</section>
			<section>
					<h2>Limits</h2>
					<ul>
						<div class=fragment><li>Message retention: up to 7 days</li></div>
						<div class=fragment><li>Throughput: 1 MB/sec per partition</li></div>
						<div class=fragment><li>Message size: 1 MB maximum</li></div>
						<div class=fragment><li>API calls per second: 5 getMessages per partition</li></div>
						<div class=fragment><li>Max Total Data Write per second: 1 MB per partition</li></div>
						<div class=fragment><li>Number of partitions: Enterprise tenancy: 5, Non-Enterprise: 0</li>
					</ul>
				</section>
			<section>
				<h2>Mushop Shipping and Stream Service</h2>
				
				<div class="mu-flex mu-flex-middle mu-margin">
						<div class="mu-svc">
							<img data-src="/images/tech/java.png" /> Order
						</div>
						<div class="mu-flex-connector arrow"></div>
						<div class="fragment mu-svc">
							<img data-src="/images/tech/java.png" /> Shipping
						</div>
						<div class="mu-flex-connector arrow"></div>
						<div class="fragment mu-svc">
							<img data-src="/images/tech/streaming.svg" /> OSS
						</div>
						<div class="mu-flex-connector arrow"></div>
						<div class="fragment mu-svc">
							<img data-src="/images/tech/java.png" /> Stream
						</div>
						<div class="mu-flex-connector arrow"></div>
						<div class="fragment mu-svc">
							<img data-src="/images/streams/shipping-2.png" /> Fulfillment
						</div>
					</div>
			</section>
			<section>
				<h2>Connecting to OSS</h2>
				<ul>
					<div class=fragment><li>Generate API signing key and public key</li></div>
					<div class=fragment><li>Upload public key to OCI</li></div>
				</ul>
			</section>
			<section>
					<h2>Connecting to OSS</h2>
					<p>Create a secret that has all IDs and API key needed for authentication</p>
					<img data-src="/images/k8s/secret.png" />
				</section>
			<section>
					<h2>Connecting to OSS</h2>
					<pre><code class="hljs text">env:
	- name: OCI_TENANT_ID
		valueFrom:
		secretKeyRef:
		name: streams-secret
		key: oci_tenant_id
	- name: OCI_USER_ID
		valueFrom:
		secretKeyRef:
		name: streams-secret
		key: oci_user_id
	- name: OCI_FINGERPRINT
		valueFrom:
		secretKeyRef:
		name: streams-secret
		key: oci_fingerprint
					</code></pre>			
			</section>
			<section>
					<h2>Connecting to OSS</h2>
					<ul>
						<li>In Java get credentials/IDs from environment</li>
					</ul>
					<pre><code class="hljs text">final String tenantId = env.getProperty("OCI_TENANT_ID");
final String userId = env.getProperty("OCI_USER_ID");
final String fingerprint = env.getProperty("OCI_FINGERPRINT");
final String privateKey = env.getProperty("OCI_API_KEY");
final String passPhrase = env.getProperty("OCI_PASS_PHRASE");
final String region = env.getProperty(“OCI_REGION”);</code></pre>
			</section>
			<section>
				<h2>Connecting to OSS</h2>
				<ul>
					<li>Create an authentication object</li>
				</ul>
				<pre><code class="hljs text">AuthenticationDetailsProvider provider =  
	SimpleAuthenticationDetailsProvider.builder()
		tenantId(tenantId)
		userId(userId)
		fingerprint(fingerprint)
		privateKeySupplier(
		new StringPrivateKeySupplier(privateKey))
		region(Region.fromRegionId(region))
		build();
				</code></pre>
			</section>
			<section>
					<h2>Publishing message to OSS</h2>
					<pre><code class="hljs text">PutMessagesDetails messagesDetails =
	PutMessagesDetails.builder()
	.messages(messages).build();
					</code></pre>
					<pre><code class="hljs text">PutMessagesRequest putRequest =
	PutMessagesRequest.builder()
	.streamId(streamsConfig.getStreamId())
	.putMessagesDetails(messagesDetails)
	.build();
					</code></pre>
					<pre><code class="hljs text">PutMessagesResponse putResponse = 
	streamsConfig.getStreamClient().
	putMessages(putRequest);
					</code></pre>
			</section>

			<section>
					<h2>Consuming message from OSS</h2>
					[Still need to add content here]
			</section>

			<!-- Lab -->
			<section>
					<h2>Hands-on Practice</h2>
					For this hands-on practice lab you will need to fix the source code which has missing functionality.
					But first you need to checkout a branch. 
					<pre><code class="hljs text">git clone -b workshop/shipping-lab git@orahub.oraclecorp.com:ateam/mushop-oci-demo.git</code></pre>
			</section>
			<section>
					<h2>Shipping Service Code Changes</h2>
					First you need to make changes to the producer, Shipping microservice. Edit the following file:
					<pre><code class="hljs text">mushop/src/shipping/src/main/java/mushop/shipping/configuration/OciStreamsConfiguration.java</code></pre>
					Modify the initConnection method. Instruction are found as inline comments. 
			</section>
			<section>
					<h2>Shipping Service Code Changes</h2>
					Next edit the following file:
					<pre><code class="hljs text">mushop/src/shipping/src/main/java/mushop/shipping/streams/StreamsPublisher.java</code></pre>
					Modify the publishMessages method. Instruction are found as inline comments. 
			</section>
			<section>
					<h2>Stream Service Code Changes</h2>
					Now you need to make changes to the consumer, Stream microservice. Edit the following file:
					<pre><code class="hljs text">mushop/src/stream/src/main/java/mushop/stream/configuration/OciStreamsConfiguration.java</code></pre>
					Modify the initConnection method. Instruction are found as inline comments. 
			</section>
			<section>
					<h2>Stream Service Code Changes</h2>
					Next edit the following file:
					<pre><code class="hljs text">mushop/src/stream/src/main/java/mushop/stream/AppStartupRunner.java</code></pre>
					Modify the forEverMessageLoop and getCursorByPartition methods. Instruction are found as inline comments. 
			</section>
			<section>
					<h2>Test and Build</h2>
					Using you preferred IDE, run the application. 
					You can check if your message is being published by looking at the OSS stream in the OCI console for intvravipati, mushop compartment. 
					<pre><code class="hljs text">https://console.us-phoenix-1.oraclecloud.com/?tenant=intvravipati</code></pre>
					The stream name is shipping-stream. 
					Click the “Refresh” button in Recent Messages to see the latest messages.
			</section>
			<section>
					<h2>Build docker image</h2>
					Now that you have checked that application runs fine and messages are being published to the stream, it's time to build the docker image. 
					Make sure you are in the correct folder. You will see a Dockerfile there.
					<pre><code class="hljs text">mushop/src/shipping</code></pre>
					Build the image. 
					<pre><code class="hljs text">docker build . --tag shipping:0.0.1</code></pre>
			</section>
			<section>
					<h2>Update deployment descriptor</h2>
					Edit shipping.yaml and update the correct image name. It should look like this:
					<pre><code class="hljs text">- image: shipping:0.0.1</code></pre>
					Also remove the following line:
					<pre><code class="hljs text">imagePullPolicy: Always</code></pre>
			</section>
			<section>
					<h2>Create a deployment</h2>
					Run this command:
					<pre><code class="hljs text">kubectl create -f shipping.yaml -n mushop</code></pre>
					This creates a deployment called shipping and a service
			</section>
			<section>
					<h2>Verify resources were created</h2>
					To list all pods in the namespace mushop run this:
					<pre><code class="hljs text">kubectl get po -n mushop</code></pre>
					Note that you can use shortcuts for several commands (po = pods, -n = namespace)
					Repeat the same series of steps (begining at building an image) for the stream application.
			</section>
			<section>
					<h2>Prepare to watch the logs</h2>
					To tail the application logs first you need to find the pod name of shipping and stream apps. 
					Then in two separate terminal windows (one for shipping, one for stream) run the following but replace pod_name with the actual pod name that you saved: 
					<pre><code class="hljs text">kubectl logs -f pod_name -n mushop</code></pre>
			</section>
			<section>
					<h2>Send message to shipping</h2>
					Open another terminal and run the following command which sends a test message to the shipping microservice running as a pod in your local Kubernetes cluster.
					<pre><code class="hljs text">curl -X POST \
http://localhost/shipping \
-H 'Content-Type: application/json' \
-H 'cache-control: no-cache' \
-d '{ 
	"id": "123-45-8876",
	"name": "shipment 500" 
}’
						  </code></pre>
			</section>
			<section>
					<h2>Watch the logs</h2>
					Look at the terminal windows and observe messages being created in the shipping and consumed in the stream. 
					You should also look at the OCI console. Refresh the table and watch your message being published to the stream.
			</section>
		</div>
	</div>
	<!-- ateam stamp / home -->
	<a href="#home" class="mu-ateam-water">
		<img src="/images/ateam.png" />
	</a>

	<script src="/js/reveal.js"></script>

	<script>
		// More info about config & dependencies:
		// - https://github.com/hakimel/reveal.js#configuration
		// - https://github.com/hakimel/reveal.js#dependencies
		Reveal.initialize({
			history: true,
			fragmentInURL: true,
			transition: 'slide',
			dependencies: [
				{ src: '/plugin/markdown/marked.js' },
				{ src: '/plugin/markdown/markdown.js' },
				{ src: '/plugin/notes/notes.js', async: true },
				{ src: '/plugin/highlight/highlight.js', async: true }
			]
		});
	</script>
</body>

</html>