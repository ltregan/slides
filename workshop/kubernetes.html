<!-- title -->
<section>
  <!-- landing -->
  <section id="home">
    <h1>Cloud Native OCI</h1>
    <h2>Kubernetes/OKE</h2>
    include "partials/_titleSlide.html"
  </section>

  <!-- TOC -->
  <section id="toc">
    <h2>Table of Contents</h2>
    <ul class="plain">
      <!-- add a line for each <section id="slideId">...</section>  -->
      <li><a href="#home">Home</a></li>
      <li><a href="#k8s_intro">Kubernetes Overview</a></li>
      <li><a href="#lab">Lab</a></li>
      <li><a href="#more-exercises">More Exercises</a></li>
    </ul>
  </section>
</section>

<!-- Kubernetes -->
<section id="k8s_intro">
  <section>
    <h2>Kubernetes Overview</h2>
    <ul>
      <li>Architecture</li>
      <li>Building Blocks</li>
      <li>Kubernetes on OCI</li>
    </ul>
  </section>
  <section data-markdown="/markdown/kubernetes.md"
         data-separator-notes="^Note:"
         data-charset="iso-8859-15">

</section>

  <section>
    <h2>Oracle Container Engine for Kubernetes (OKE)</h2>
    Managed Kubernetes Services (CaaS)
    <img class="plain" data-src="/images/k8s/oracle_managed.png" alt="Service" />
  </section>
  <section>
    <h2>Oracle Container Engine for Kubernetes (OKE)</h2>
    <img class="plain" data-src="/images/k8s/oke_ha.png" alt="Service" />
  </section>
  <section>
    <h2>In-place upgrade - master nodes</h2>
    <img class="plain" data-src="/images/k8s/oke_ha.png" alt="Service" />
  </section>
  <section>
    <h2>Deployment Manifests</h2>
    <p class="mu-small">
    Shown below is a simple deployment manifest for the MuShop <code>storefront</code> service
    </p>
    <pre><code class="fragment hljs yaml mu-small">
apiVersion: apps/v1
kind: Deployment
metadata:
  name: storefront
  labels:
    app.kubernetes.io/name: storefront
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: storefront
  template:
    metadata:
      labels:
        app.kubernetes.io/name: storefront
    spec:
      containers:
        - name: storefront
          image: "iad.ocir.io/oracle/ateam/mushop-storefront:2.0.0"
          ports:
            - name: http
              containerPort: 8080
            - name: status
              containerPort: 8888
          livenessProbe:
            httpGet:
              path: /
              port: http
          readinessProbe:
            httpGet:
              path: /
              port: http
          volumeMounts:
          - mountPath: /tmp
            name: tmp-volume
          resources:
            limits:
              cpu: 300m
              memory: 300Mi
            requests:
              cpu: 100m
              memory: 100Mi
            
          securityContext:
            capabilities:
              add:
              - NET_BIND_SERVICE
              - CHOWN
              - SETGID
              - SETUID
              drop:
              - all
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 10001
            
      volumes:
        - name: tmp-volume
          emptyDir:
            medium: Memory</code></pre>
  </section>
  <section>
    <h2>The Problem</h2>
    <ul class="mu-medium">
      <li>Steep learning curve when implementing Kubernetes</li>
      <li>Increased complexity of microservice environments</li>
      <li>Manual application deployment using kubectl</li>
      <li>Kubernetes treats your application as a number of decoupled resources</li>
      <li>More deployment steps means more chances for human error</li>
      <li>Hard to share and distribute microservice applications</li>
      <li>Hard to manage application releases</li>
    </ul>
  </section>
  <section>
    <h2>The Solution: Helm</h2>
    <ul class="mu-medium">
      <li>Package management tool for Kubernetes</li>
      <li>A CNCF project</li>
      <li>A package manager similar to <code>yum</code>, <code>brew</code>, <code>apt-get</code>, <code>npm</code>,
        <code>choco</code>, etc., but
        specifically
        for
        Kubernetes</li>
      <li>Method for repeatable application installation, configuration, and versioning through the
        use of charts, repositories, and releases</li>
      <li>Repository of existing templates for standard software</li>
    </ul>
  </section>
  <section>
    <h2>Helm</h2>
    <img class="plain" data-src="/images/helm/helm.png" alt="Helm" />
  </section>
</section>

<!-- Lab -->
<section id="lab">
  <section id="lab">
    <h2>Lab Overview</h2>
    <ul>
      <li>Get Source Code</li>
      <li>Cluster Setup</li>
      <li>Create a deployment with Helm</li>
      <li>Verify</li>
    </ul>
  </section>

  <section id="sourcecode">
include "_sourceCode.html"
  </section>

  <section id="setup">
include "_okeSetup.html"
  </section>

  <section id="exercise">
    <h2>Deploy MuShop</h2>
    <div class="mu-flex mu-small switcher">
      <ul>
        <li class="fragment">Setting K8s Context</li>
        <li class="fragment">Change Namespace</li>
        <li class="fragment">Deploy with Helm</li>
        <li class="fragment">Open App</li>
        <li class="fragment">Under the Hood</li>
      </ul>
      <ul class="col-1-1">
        <!-- context -->
        <li>
          If available, you may wish to perform these tasks in 
          an OKE cluster instead of a local cluster. <span class="mu-muted">OPTIONAL</span>
          <hr/>
          <div class="mu-flex mu-gutter mu-flex-stretch">
            <div class="col-1-2">
              <p>Use Docker Desktop UI:</p>
              <img class="no-margin" data-src="/images/k8s/switch_context2.png" alt="k8s switch" />
            </div>
            <div class="mu-valign mu-muted no-wrap">- OR -</div>
            <div class="col-1-2">
              <p>Use the command line:</p>
              <pre><code class="hljs text">kubectl config get-contexts</code></pre>
              <pre><code class="hljs text">kubectl config use-context &lt;name&gt;</code></pre>
              <blockquote class="mu-small">
                <b>TIP:</b> use <a href="https://github.com/ahmetb/kubectx" target="_blank">kubectx</a>
                to switch context easily &amp; often from the command line
              </blockquote>
            </div>
          </div>
        </li>
        <!-- namespace -->
        <li>
include "_changenamespace.html"
        </li>
        <!-- deploy -->
        <li>
          Remembering that <code>helm</code> provides a way of packaging and deploying <em>configurable</em>
          charts, next we will deploy the application in <em>"mock mode"</em> where cloud services are
          mocked, yet the application is fully functional
          <hr />
          <p>
            ⚠️ <b>NOTE:</b> Ensure <a href="#setup" target="_blank">setup</a>
            steps were completed, and any prior installations are removed
          </p>
          <div class="mu-flex mu-flex-stretch mu-gutter mu-small">
            <div class="card col-1-2">
              <b>Without</b> a hostname:
              <pre><code class="hljs sh">helm install mushop \
  deploy/complete/helm-chart/mushop \
  --set global.mock.service="all"</code></pre>
            </div>
            <div class="mu-muted no-wrap mu-valign">OR</div>
            <div class="card col-1-2">
              <b>With</b> a hostname:
              <pre><code class="hljs sh">helm install mushop \
  deploy/complete/helm-chart/mushop \
  --set global.mock.service="all" \
  --set ingress.hosts[0]="yourname.mushop.com"</code></pre>
            </div>
          </div>
          <div class="mu-small mu-margin mu-margin-top"><pre><code class="hljs text">########################################
    __  __        _____ _                 
  |  \/  |      / ____| |                
  | \  / |_   _| (___ | |__   ___  _ __  
  | |\/| | | | |\___ \| '_ \ / _ \| '_ \ 
  | |  | | |_| |____) | | | | (_) | |_) |
  |_|  |_|\__,_|_____/|_| |_|\___/| .__/ 
                                  | |    
                                  |_|    
########################################</code></pre>
          </div>
          <pre><code class="hljs text">kubectl get pod --watch</code></pre>
          <blockquote class="mu-medium">
            ⏲️ It may take a few moments to download all the application images.
          </blockquote>
        </li>
        <!-- launch -->
        <li>
          After inspecting the resources created with <code>helm install</code>,
          go ahead and launch the application in your browser.
          <hr/>
include "_openmushop.html"
        </li>
        <li>
          To get a beter look at all the installed Kubernetes manifests by
          using the <b><code>template</code></b> command:
          <hr>
          <pre><code class="hljs text">mkdir ./out</code></pre>
          <pre><code class="hljs text">helm template mushop deploy/complete/helm-chart/mushop \
  --set global.mock.service="all" \
  --output-dir ./out</code></pre>
          Explore the files, and see each output. Example:
          <div class="mu-medium">
          <pre class="mu-ratio mu-ratio-5-2"><code class="hljs yaml"># Source: mushop/charts/api/templates/api-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mushop-api
  labels:
    app.kubernetes.io/name: api
    helm.sh/chart: api-0.1.0
    app.kubernetes.io/instance: mushop
    layer: client
    app.kubernetes.io/version: "0.1.0"
    app.kubernetes.io/managed-by: Tiller
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: api
      app.kubernetes.io/instance: mushop
      layer: client
  template:
    metadata:
      labels:
        app.kubernetes.io/name: api
        app.kubernetes.io/instance: mushop
        layer: client
    spec:
      containers:
        - name: api
          image: "iad.ocir.io/oracle/ateam/mushop-api:2.0.0"
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 3000
          env:
          - name: MOCK_MODE
            value: "all"
          - name: SESSION_REDIS
            value: mushop-session
          - name: CATALOGUE_URL
            value: http://mushop-catalogue
          - name: ORDERS_URL
            value: http://mushop-orders
          - name: CARTS_URL
            value: http://mushop-carts
          - name: USERS_URL
            value: http://mushop-user
          - name: STATIC_MEDIA_URL
            value: ""
          livenessProbe:
            httpGet:
              path: /health
              port: http
          readinessProbe:
            httpGet:
              path: /health
              port: http
          resources:
            limits:
              cpu: 300m
              memory: 300Mi
            requests:
              cpu: 100m
              memory: 100Mi
            
          securityContext:
            capabilities:
              add:
              - NET_BIND_SERVICE
              drop:
              - all
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 10001</code></pre>
          </div>
        </li>
      </ul>
    </div>
  </section>

</section>

<!-- Kubernetes exercises -->
<section id="more-exercises" data-markdown="/markdown/k8s-exercises.md"
       data-separator-notes="^Note:"
       data-charset="iso-8859-15">
</section>