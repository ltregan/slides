<!-- title -->
<section>
  <!-- landing -->
  <section id="home">
    <h1>Cloud Native OCI</h1>
    <h2>Shipping and Streaming</h2>
    include "partials/_titleSlide.html"
  </section>

  <!-- TOC -->
  <section id="toc">
    <h2>Table of Contents</h2>
    <ul class="plain">
      <!-- add a line for each <section id="slideId">...</section>  -->
      <li><a href="#oss_intro">Home</a></li>
      <li><a href="#lab">Lab Overview</a></li>
    </ul>
  </section>
</section>


<!-- Streams -->
<section id="oss_intro">
  <section>
    <h2>Oracle Streaming Service</h2>
    <ul>
      <li>What is OSS?</li>
      <li>Use cases</li>
      <li>Concepts</li>
      <li>How it works</li>
      <li>Limits</li>
    </ul>
  </section>
  <section>
    <h2>What is OSS? <img data-src="/images/tech/streaming.svg" /></h2>
    <ul>
      <li class=fragment>The OCI Streaming Service provides a fully managed, scalable, and durable storage solution for
        ingesting continuous, high-volume streams of data that you can consume and process in real time</li>
      <li class=fragment>OSS is a distributed event-log</li>
      <li class=fragment>Messages are written to partitions and can be referenced via partition/offset</li>
    </ul>
    <aside class="notes" data-markdown>
      Storage solution for ingesting continuous, high-volume streams of data.
    </aside>
  </section>
  <section>
    <h2>Use cases</h2>
    <ul>
      <li>Metric and log ingestion</li>
      <div class=fragment>
        <li>Messaging</li>
      </div>
      <div class=fragment>
        <li>Web/Mobile activity data ingestion</li>
      </div>
      <div class=fragment>
        <li>Infrastructure and apps event processing</li>
      </div>
      <div class=fragment>
        <li>Oracle Data Cloud</li>
      </div>
    </ul>
  </section>
  <section>
    <h2>Concepts</h2>
    <div class="mu-flex mu-gutter">
      <div class="col-1-2">
        <p class="mu-left mu-small fragment"><strong>Stream</strong>: a partitioned, append-only log of messages</p>
        <p class="mu-left mu-small fragment"><strong>Message</strong>: base64-encoded record that is published to the
          stream</p>
        <p class="mu-left mu-small fragment"><strong>Offset</strong>: the location of a message within a partition.</p>
        <p class="mu-left mu-small fragment"><strong>Producer</strong>: an entity that writes/publishes messages to a
          stream.</p>
        <p class="mu-left mu-small fragment"><strong>Consumer</strong>: an entity that reads messages from one or more
          streams.</p>
      </div>
      <div class="col-1-2">
        <p class="mu-left mu-small fragment"><strong>Partition</strong>: a section of a stream. It allows you to
          distribute a stream by splitting messages across multiple nodes. Each partition can be placed on a separate
          machine to allow for multiple consumers to read from a stream in parallel.</p>
        <p class="mu-left mu-small fragment"><strong>Cursor</strong>: a pointer to a location (offset or time) in a
          stream.</p>
      </div>
    </div>
  </section>
  <section>
    <h2>Concepts</h2>
    <h4>Cursor Type: AT_OFFSET</h4>
    <p class="mu-small">Consume at a specified offset.</p>
    <img class="plain" data-src="/images/streams/at_offset.png" alt="at_offset cursor" />
    <aside class="notes" data-markdown>
      Start consuming at a specified offset. The offset must be greater than or equal to the offset of the oldest
      message and less than or equal to the latest published offset.
    </aside>
  </section>
  <section>
    <h2>Concepts</h2>
    <h4>Cursor Type: AFTER_OFFSET</h4>
    <p class="mu-small">Consume after the given offset.</p>
    <img class="plain" data-src="/images/streams/after_offset.png" alt="after_offset cursor" />
    <aside class="notes" data-markdown>
      Start consuming after the given offset. This cursor has the same restrictions as the AT_OFFSET cursor.
    </aside>
  </section>
  <section>
    <h2>Concepts</h2>
    <h4>Cursor Type: TRIM_HORIZON</h4>
    <p class="mu-small">Consume from the oldest available message.</p>
    <img class="plain" data-src="/images/streams/trim_horizon.png" alt="trim_horizon cursor" />
    <aside class="notes" data-markdown>
      Start consuming from the oldest available message in the stream. Create a cursor at the TRIM_HORIZON to consume
      all
      messages in a stream.
    </aside>
  </section>
  <section>
    <h2>Concepts</h2>
    <h4>Cursor Type: AT_TIME</h4>
    <p class="mu-small">Consume after given time. Timestamp of the message &ge; supplied time.</p>
    <img class="plain" data-src="/images/streams/at_time.png" alt="at_time cursor" />
    <aside class="notes" data-markdown>
      Start consuming from a given time. The timestamp of the returned message will be on or after the supplied time
    </aside>
  </section>
  <section>
    <h2>Concepts</h2>
    <h4>Cursor Type: LATEST</h4>
    <p class="mu-small">Consume messages published after the cursor creation.</p>
    <img class="plain" data-src="/images/streams/latest.png" alt="latest cursor" />
    <aside class="notes" data-markdown>
      Start consuming messages that were published after you created the cursor.
    </aside>
  </section>
  <section>
    <h2>Service Limits</h2>
    <div class="testimonials mu-small">
      <ul class="mu-flex mu-gutter mu-wrap">
        <li class="card col-1-1 fragment">Message retention: up to 7 days</li>
        <li class="card col-1-1 fragment">Throughput: 1 MB/sec per partition</li>
        <li class="card col-1-1 fragment">Message size: 1 MB maximum</li>
        <li class="card col-1-1 fragment">API calls per second: 5 getMessages per partition</li>
        <li class="card col-1-1 fragment">Max Total Data Write per second: 1 MB per partition</li>
        <li class="card col-1-1 fragment">Number of partitions: Enterprise: 5, Non-Enterprise: 0</li>
      </ul>
    </div>
  </section>
  <section>
    <h2>Mushop Use Case</h2>

    <div class="mu-flex mu-flex-middle mu-margin">
      <div class="mu-svc fragment fade-in">
        <img data-src="/images/tech/java.png" /> Order
      </div>
      <div class="mu-flex-connector arrow fragment fade-in"></div>
      <div class="mu-svc fragment fade-in">
        <img data-src="/images/tech/java.png" /> Shipping
      </div>
      <div class="mu-flex-connector arrow fragment fade-in">producer</div>
      <div class="mu-svc fragment fade-in">
        <img data-src="/images/tech/streaming.svg" /> OSS
      </div>
      <div class="mu-flex-connector arrow-left fragment fade-in">consumer</div>
      <div class="mu-svc fragment fade-in">
        <img data-src="/images/tech/java.png" /> Stream
      </div>
      <div class="mu-flex-connector arrow fragment fade-in"></div>
      <div class="mu-svc fragment fade-in">
        <img data-src="/images/streams/shipping-2.png" /> Fulfillment
      </div>
    </div>

    <aside class="notes" data-markdown>
      We have two services as part of MuShop using the streaming service. First, we have the <b><code>shipping</code></b>
      service: once an order is created, shipping service puts a message with order information on to the stream. Then,
      we have stream consumer that simply reads those messages from a stream as they come in.
    </aside>
  </section>
  <section>
    <h2>Connecting to OSS</h2>
    <div class="mu-flex mu-gutter">
      <div class="card col-1-2">
        Using APIs
        <hr>
        <ol class="mu-small">
          <li class="mu-left fragment">Generate API signing and public key</li>
          <li class="mu-left fragment">Upload public key to OCI
            <blockquote class="mu-medium no-margin">
              See <a href="/workshop/prepare.html#tenancy" target="_blank">setup</a> for API user configuration.
            </blockquote>
          </li>
          <li class="mu-left fragment">Configure the application</li>
          <li class="mu-left fragment">
            Utilize SDKs connect to OSS
            <blockquote class="mu-medium no-margin">
              <a href="https://docs.cloud.oracle.com/iaas/Content/API/Concepts/sdks.htm" target="_blank">
                OCI SDKs</a> (Java, Python, Ruby and Go)
            </blockquote>
          </li>
        </ol>
      </div>
      <div class="mu-muted mu-valign no-wrap">- OR -</div>
      <div class="card col-1-2">
        Kafka Compatibility
        <hr>
        ðŸ†•
      </div>
    </div>
  </section>
  <section>
    <h2>Connecting from K8s</h2>
    <div class="mu-medium">
      Using a secret with credentials needed for API authentication, and resource
      specifics.
    </div>
    <hr>
    <div class="mu-flex mu-gutter mu-small">
      <div class="card col-1-2">
        <img class="fragment" data-src="/images/k8s/secret.png" />
      </div>
      <div class="card col-1-2 mu-medium">
        Sample Kubernetes deployment configurations:
        <pre class="mu-ratio mu-ratio-1-1"><code class="hljs yaml"># Source: mushop/charts/shipping/templates/shipping-deployment.yaml
env:
  # access configurations
  - name: STREAM_NAME
    valueFrom:
      secretKeyRef:
        name: mushop-oss-connection
        key: streamName
  - name: STREAM_ID
    valueFrom:
      secretKeyRef:
        name: mushop-oss-connection
        key: streamId
  - name: OCI_TENANT_ID
    valueFrom:
      secretKeyRef:
        name: streaming-secret
        key: oci_tenant_id
  - name: OCI_USER_ID
    valueFrom:
      secretKeyRef:
        name: streaming-secret
        key: oci_user_id
  - name: OCI_FINGERPRINT
    valueFrom:
      secretKeyRef:
        name: streaming-secret
        key: oci_fingerprint
  - name: OCI_PASS_PHRASE
    valueFrom:
      secretKeyRef:
        name: streaming-secret
        key: oci_pass_phrase
  - name: OCI_API_KEY
    valueFrom:
      secretKeyRef:
        name: streaming-secret
        key: oci_api_key
  - name: OCI_REGION
    valueFrom:
      secretKeyRef:
        name: streaming-secret
        key: oci_region
  - name: OCI_COMPARTMENT_ID
    valueFrom:
      secretKeyRef:
        name: streaming-secret
        key: oci_compartment_id</code></pre>
      </div>
    </div>
  </section>
  
  <section id="example">
    <h2>Connecting to OSS</h2>
    <div class="mu-small">
      The following represents an example of how an integration with OSS might
      work.
    </div>
    <hr>
    <div class="mu-flex mu-small switcher">
      <ul>
        <li class="fragment">Configuration</li>
        <li class="fragment">Auth/Client</li>
        <li class="fragment">Producer</li>
        <li class="fragment">Consumer</li>
      </ul>
      <ul class="col-1-1">
        <li>
          <div class="mu-margin">
            In Java get credentials/IDs from environment:
          </div>
          <pre><code class="hljs java">final String tenantId = env.getProperty("OCI_TENANT_ID");
              final String userId = env.getProperty("OCI_USER_ID");
              final String fingerprint = env.getProperty("OCI_FINGERPRINT");
              final String privateKey = env.getProperty("OCI_API_KEY");
              final String passPhrase = env.getProperty("OCI_PASS_PHRASE");
              final String region = env.getProperty("OCI_REGION");
              final String compartmentId = env.getProperty("OCI_COMPARTMENT_ID");
              final String streamId = env.getProperty("STREAM_ID");</code></pre>
        </li>
        <li>
          <div class="mu-margin">
            Create auth provider and stream client objects:
          </div>
          <pre><code class="hljs java">AuthenticationDetailsProvider provider =  
SimpleAuthenticationDetailsProvider.builder()
    .tenantId(tenantId)
    .userId(userId)
    .fingerprint(fingerprint)
    .privateKeySupplier(new StringPrivateKeySupplier(privateKey))
    .region(Region.fromRegionId(region))
    .build();
  
final StreamAdminClient adminClient = new StreamAdminClient(provider);
Stream stream = getStream(adminClient, compartmentId, streamName, partitions);

streamClient = new StreamClient(provider);
streamClient.setEndpoint(stream.getMessagesEndpoint());</code></pre>
        </li>
        <li>
          <div class="mu-margin">
            Publishing messages to OSS:
          </div>
          <pre class="mu-small"><code class="hljs java">PutMessagesDetails messagesDetails = PutMessagesDetails.builder()
  .messages(messages)
  .build();</code></pre>
          <pre class="mu-small"><code class="hljs java">PutMessagesRequest putRequest = PutMessagesRequest.builder()
  .streamId(streamsConfig.getStreamId())
  .putMessagesDetails(messagesDetails)
  .build();</code></pre>
          <pre class="mu-small"><code class="hljs java">PutMessagesResponse putResponse = streamsConfig.getStreamClient()
  .putMessages(putRequest);</code></pre>
        </li>
        <li>
          <div class="mu-margin">
            Consuming messages in the Stream:
          </div>
          <div class="mu-flex mu-gutter">
            <div class="col-1-2 mu-medium">
              1. Create a cursor:
              <pre><code class="hljs java">CreateCursorDetails cursorDetails =
  CreateCursorDetails.builder()
  .partition(partition)
  .type(Type.Latest)
  //.type(Type.TrimHorizon)
  //.type(Type.AtOffset)
  .build();

CreateCursorRequest createCursorRequest =
  CreateCursorRequest.builder()
  .streamId(streamId)
  .createCursorDetails(cursorDetails)
  .build();

CreateCursorResponse cursorResponse = 
  streamClient.createCursor(createCursorRequest);
  return cursorResponse.getCursor().getValue();</code></pre>
            </div>
            <div class="col-1-2 mu-medium">
              2. Get messages:
              <pre><code class="hljs java">for (;;) {
  GetMessagesRequest getRequest =
    GetMessagesRequest.builder()
      .streamId(streamId)
      .cursor(cursor)
      .limit(10)
      .build();

  GetMessagesResponse getResponse = streamClient.getMessages(getRequest);
  //Extract Json message from getResponse
  //Print message
}</code></pre>
            </div>
          </div>
        </li>
        
      </ul>
    </div>
  </section>

</section> <!-- end of lecture-->

<!-- Lab -->
<section id="lab">
  <section>
    <h2>Hands-on Practice</h2>
    <p class="mu-small mu-left">
      For this practice lab you will update the source code to put an additional message on the stream.
    </p>
    <p class="mu-small mu-left">You will create an additional shipment in the following controller file:</p>
    <pre><code class="hljs text">mushop/src/shipping/src/main/java/mushop/shipping/controller/ShippingController.java</code></pre>
    <p class="mu-small mu-left">Locate the <code>postShipping</code> method and right under the
      <code>publishMessage</code> call, create another
      shipment.</p>
    <pre class="mu-small"><code class="hljs java">
Shipment myShipment = new Shipment("123456", "This is an additional shippment!");
streamsPublisher.publishMessage(myShipment);
    </code></pre>
  </section>
  <section>
    <h2>Build docker image</h2>
    <p class="mu-small mu-left">To build the docker image, make sure you are in the correct folder (You will see a
      Dockerfile there)</p>
    <pre><code class="hljs text">mushop/src/shipping</code></pre>
    <p class="mu-small mu-left">Run the following to build the image.</p>
    <pre><code class="hljs text">docker build -t shipping:dev .</code></pre>
  </section>
  <section>
    <h2>Update the Helm chart values file</h2>
    <p class="mu-small mu-left">Make a copy of the values file that can be used to only deploy the Shipping and
      Streaming service:</p>
    <pre><code class="hljs sh">cp mushop/deploy/helm-chart/mushop/values-shipping.yaml my-values-shipping.yaml</code></pre>
    <p class="mu-small mu-left">Next, you need to open the file and fill out the missing values (image name you built as
      well as OCI information):</p>
    <pre><code class="hljs yaml mu-small">shipping:
  enabled: true
  image:
    repository: IMAGE NAME HERE
    tag: IMAGE TAG HERE
    imagePullPolicy: Never

secrets:
  streams:
    compartmentId: OCI_COMPARTMENT_ID
    tenantId: OCI_TENANT_ID
    userId: OCI_USER_ID
    fingerprint: OCI_FINGERPRINT
    region: OCI_REGION
    passphrase: OCI_PASSPHRASE
    streamName: STREAM_NAME
    </code></pre>
  </section>
  <section>
    <h2>Create a deployment</h2>
    <p class="mu-small mu-left">The following command deploys a Helm chart using the values file you created:
    </p>
    <pre><code class="hljs sh">helm install -f deploy/helm-chart/mushop/my-values-shipping.yaml deploy/helm-chart/mushop
        --name shipping --namespace mushop</code></pre>
    <p class="mu-small mu-left">To verify the pod and service were created, list all resources in the namespace
      <code>mushop</code>:
    </p>
    <pre><code class="hljs text">kubectl get all --namespace mushop</code></pre>
    <p class="mu-small mu-left">Repeat the same series of steps (begining at building an image) for the
      <code>stream</code>
      service. Make sure you provide the image information in the <code>values.yaml</code> file.</p>
  </section>
  <section>
    <h2>Prepare to watch the logs</h2>
    <p class="mu-small mu-left">
      To tail the application logs first you need to find the <code>shipping</code> and <code>stream</code> pod names.
      Then, in two separate terminal windows (one for <code>shipping</code>, one for <code>stream</code>), run the
      following but replace <code>pod_name</code>
      with the actual pod name that you saved, and <code>namespace_name</code> with the namespace where you deployed the
      services to:
    </p>
    <pre><code class="hljs text">kubectl logs -f pod_name -n namespace_name</code></pre>
  </section>
  include "partials/highlights/_testshipping.html"
  <section>
    <h2>Shipping and stream output</h2>
    <pre><code class="hljs text mu-small">
  # Shipping service output
  {"name":"shipment 500","id":"123-45-8876"}
  Created a list with one message
  Publishing 1 messages to stream ocid1.stream.oc1.phx.aaaaaaaaa5acbmqg4t3ul6dyy3kbcihsxpw66tvpyxw7j7kesmdz3i6cc45a.
  Published message to partition 0, offset 49.
  Created a list with one message
  Publishing 1 messages to stream ocid1.stream.oc1.phx.aaaaaaaaa5acbmqg4t3ul6dyy3kbcihsxpw66tvpyxw7j7kesmdz3i6cc45a.
  Published message to partition 0, offset 50.
    </code></pre>

    <pre><code class="hljs text mu-small">
  # Stream service output
  Received shipment task: shipment 500
  Shipment{id='123-45-8876', name='shipment 500'}
  Received shipment task: shipment 500
  Shipment{id='SomeID', name='MyShippment Name!'}
  Received shipment task: MyShippment Name!
          </code></pre>
  </section>
  <section>
    <p class="mu-small mu-left">
      Click <a href="https://console.us-phoenix-1.oraclecloud.com/" target="_blank">here</a> to
      access the OCI console.
    </p>
    <div class="mu-flex mu-gutter">
      <div><img class="plain" width="100%" data-src="/images/streams/console1.png" alt="Analytics - Streaming" /></div>
      <div><img class="plain" width="100%" data-src="/images/streams/console2.png"
          alt="Analytics - Streaming - Overview" /></div>
    </div>
  </section>
  <section>
    <img class="plain" width="100%" data-src="/images/streams/console3.png"
      alt="Anaylics - Streaming - Stream Details" />
  </section>
</section> <!-- end of lab -->