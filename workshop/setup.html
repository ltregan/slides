<!-- title -->
<section id="home">
  <h1>Cloud Native OCI</h1>
  <h2>Developer Setup</h2>
  include "partials/_titleSlide.html"
</section>

<section id="options">
  <h2>Environment Options</h2>

  <ul class="plain mu-flex mu-wrap mu-flex-stretch mu-gutter">
    <li class="card col-1-3 mu-svc">
      <img data-src="/images/tech/docker.png" alt="docker" />
    </li>
    <li class="card col-1-3 mu-svc">
      <img data-src="/images/tech/k8s.png" alt="kubernetes" />
    </li>
    <li class="card col-1-3 mu-svc">
      <img data-src="/images/tech/helm.svg" alt="helm" />
    </li>
  </ul>

  <div class="mu-flex mu-flex-middle mu-small mu-margin">
    <div>Manual</div>
    <div class="mu-flex-connector arrow"></div>
    <div>Automated</div>
  </div>

  <div class="testimonials mu-margin ">
    <ul class="mu-flex mu-gutter mu-smaller mu-wrap">
      <li class="card col-1-1 fragment fade-up">
        A microservices design offers excellent separation of concerns,
        and developer independence.
      </li>
      <li class="card col-1-1 fragment fade-up">
        While these benefits are clear, they can often introduce some complexity
        for development environments.
      </li>
      <li class="card col-1-1 fragment fade-up">
        Services support configurations that offer flexibity
        as necessary, and establish parity as much as possible.
      </li>
      <li class="card col-1-1 fragment fade-up">
        Use the same tools for development - production.
      </li>
    </ul>
  </div>
</section>

<!-- Lab -->
<section id="lab">
  <section id="lab">
    <h2>Lab Overview</h2>
    <ul>
      <li>Get Source Code</li>
      <li>Cluster Setup</li>
      <li>Create a deployment with Helm</li>
      <li>Verify</li>
    </ul>
  </section>
  <section id="sourcecode">
    include "_sourceCode.html"
  </section>

  <section id="setup">
    include "_okeSetup.html"
  </section>

  <section id="exercise">
    <h2>Deploy MuShop</h2>
    <div class="mu-flex mu-small switcher">
      <ul>
        <li class="fragment">Setting K8s Context</li>
        <li class="fragment">Change Namespace</li>
        <li class="fragment">Deploy with Helm</li>
        <li class="fragment">Open App</li>
        <li class="fragment">Under the Hood</li>
      </ul>
      <ul class="col-1-1">
        <!-- context -->
        <li>
          If available, you may wish to perform these tasks in
          an OKE cluster instead of a local cluster. <span class="mu-muted">OPTIONAL</span>
          <hr />
          <div class="mu-flex mu-gutter mu-flex-stretch">
            <div class="col-1-2">
              <p>Use Docker Desktop UI:</p>
              <img class="no-margin"
                   data-src="/images/k8s/switch_context2.png"
                   alt="k8s switch" />
            </div>
            <div class="mu-valign mu-muted no-wrap">- OR -</div>
            <div class="col-1-2">
              <p>Use the command line:</p>
              <pre><code class="hljs text">kubectl config get-contexts</code></pre>
              <pre><code class="hljs text">kubectl config use-context &lt;name&gt;</code></pre>
              <blockquote class="mu-small">
                <b>TIP:</b> use <a href="https://github.com/ahmetb/kubectx"
                   target="_blank">kubectx</a>
                to switch context easily &amp; often from the command line
              </blockquote>
            </div>
          </div>
        </li>
        <!-- namespace -->
        <li>
          include "_changenamespace.html"
        </li>
        <!-- deploy -->
        <li>
          Remembering that <code>helm</code> provides a way of packaging and deploying <em>configurable</em>
          charts, next we will deploy the application in <em>"mock mode"</em> where cloud services are
          mocked, yet the application is fully functional
          <hr />
          <p>
            ⚠️ <b>NOTE:</b> Ensure <a href="#setup"
               target="_blank">setup</a>
            steps were completed, and any prior installations are removed
          </p>
          <div class="mu-flex mu-flex-stretch mu-gutter mu-small">
            <div class="card col-1-2">
              <b>Without</b> a hostname:
              <pre><code class="hljs sh">helm install mushop \
deploy/complete/helm-chart/mushop \
--set global.mock.service="all"</code></pre>
            </div>
            <div class="mu-muted no-wrap mu-valign">OR</div>
            <div class="card col-1-2">
              <b>With</b> a hostname:
              <pre><code class="hljs sh">helm install mushop \
deploy/complete/helm-chart/mushop \
--set global.mock.service="all" \
--set ingress.hosts[0]="yourname.mushop.com"</code></pre>
            </div>
          </div>
          <div class="mu-small mu-margin mu-margin-top">
            <pre><code class="hljs text">########################################
  __  __        _____ _                 
|  \/  |      / ____| |                
| \  / |_   _| (___ | |__   ___  _ __  
| |\/| | | | |\___ \| '_ \ / _ \| '_ \ 
| |  | | |_| |____) | | | | (_) | |_) |
|_|  |_|\__,_|_____/|_| |_|\___/| .__/ 
                                | |    
                                |_|    
########################################</code></pre>
          </div>
          <pre><code class="hljs text">kubectl get pod --watch</code></pre>
          <blockquote class="mu-medium">
            ⏲️ It may take a few moments to download all the application images.
          </blockquote>
        </li>
        <!-- launch -->
        <li>
          After inspecting the resources created with <code>helm install</code>,
          go ahead and launch the application in your browser.
          <hr />
          include "_openmushop.html"
        </li>
        <li>
          To get a beter look at all the installed Kubernetes manifests by
          using the <b><code>template</code></b> command:
          <hr>
          <pre><code class="hljs text">mkdir ./out</code></pre>
          <pre><code class="hljs text">helm template mushop deploy/complete/helm-chart/mushop \
--set global.mock.service="all" \
--output-dir ./out</code></pre>
          Explore the files, and see each output. Example:
          <div class="mu-medium">
            <pre class="mu-ratio mu-ratio-5-2"><code class="hljs yaml"># Source: mushop/charts/api/templates/api-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
name: mushop-api
labels:
  app.kubernetes.io/name: api
  helm.sh/chart: api-0.1.0
  app.kubernetes.io/instance: mushop
  layer: client
  app.kubernetes.io/version: "0.1.0"
  app.kubernetes.io/managed-by: Tiller
spec:
replicas: 1
selector:
  matchLabels:
    app.kubernetes.io/name: api
    app.kubernetes.io/instance: mushop
    layer: client
template:
  metadata:
    labels:
      app.kubernetes.io/name: api
      app.kubernetes.io/instance: mushop
      layer: client
  spec:
    containers:
      - name: api
        image: "iad.ocir.io/oracle/ateam/mushop-api:2.0.0"
        imagePullPolicy: Always
        ports:
          - name: http
            containerPort: 3000
        env:
        - name: MOCK_MODE
          value: "all"
        - name: SESSION_REDIS
          value: mushop-session
        - name: CATALOGUE_URL
          value: http://mushop-catalogue
        - name: ORDERS_URL
          value: http://mushop-orders
        - name: CARTS_URL
          value: http://mushop-carts
        - name: USERS_URL
          value: http://mushop-user
        - name: STATIC_MEDIA_URL
          value: ""
        livenessProbe:
          httpGet:
            path: /health
            port: http
        readinessProbe:
          httpGet:
            path: /health
            port: http
        resources:
          limits:
            cpu: 300m
            memory: 300Mi
          requests:
            cpu: 100m
            memory: 100Mi
          
        securityContext:
          capabilities:
            add:
            - NET_BIND_SERVICE
            drop:
            - all
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 10001</code></pre>
          </div>
        </li>
      </ul>
    </div>
  </section>
</section>

<!-- exercise -->
<section id="setup" data-background-image="/images/logo.png" data-background-size="150px"
  data-background-position="20px 20px">
  <h2>Develop MuShop</h2>

  <div class="mu-flex mu-small switcher">
    <ul>
      <li class="fragment">Get Source Code</li>
      <li class="fragment">Prepare Cluster</li>
      <li class="fragment">Install MuShop</li>
      <li class="fragment">Launch App</li>
    </ul>
    <ul class="col-1-1">
      <li>

        <div class="mu-flex mu-flex-stretch mu-gutter">
          <div class="card col-1-2">
            <code>&gt;</code> Clone with <code>git</code>
            <ol class="mu-small mu-steps">
              <li>Open <a href="https://github.com/oracle-quickstart/oci-cloudnative" target="blank">repo</a></li>
              <li>
                Click <a class="oui-button oui-button-primary">Clone or download</a>
              </li>
            </ol>
            <div class="mu-medium mu-margin-top">
              <pre><code class="hljs text">git clone https://github.com/oracle-quickstart/oci-cloudnative.git mushop
cd mushop</code></pre>
              <blockquote class="mu-small">
                (Or clone with SSH)
              </blockquote>
            </div>
          </div>
          <div class="mu-muted no-wrap mu-valign">- OR -</div>
          <div class="card col-1-2">
            <code>&gt;</code> <a href="https://github.com/oracle-quickstart/oci-cloudnative/archive/develop.zip">Download</a>
            <blockquote class="mu-small">
              Extract contents to a folder available on your disk
            </blockquote>
          </div>
        </div>
        <div class="mu-small mu-margin-top">
include "_mushopTree.html"
        </div>
      </li>
      <li>
include "_setupchart.html"
      </li>
      <!-- deploy -->
      <li>
        MuShop application supports a simplified deployment called <em>"mock mode"</em>
        with only minimum service requirements.
        <hr />
        <div class="mu-margin">
          💻 Download <a href="/public/mushop.setup.yaml">mushop.setup.yaml</a>
        </div>
        <pre><code class="hljs sh">kubectl create -f mushop.setup.yaml</code></pre>
        <pre><code class="hljs text">kubectl get pod --watch</code></pre>
        <blockquote class="mu-medium">
          ⏲️ It may take a few moments to download all the application images.
          It is also normal for some to show errors in mock mode.
        </blockquote>
      </li>
      <!-- launch -->
      <li>
include "_openmushop.html"
        <blockquote class="mu-medium">
          ℹ️ To completely remove the application, use the following command:
          <pre><code class="hljs sh">kubectl delete -f mushop.setup.yaml</code></pre>
        </blockquote>
      </li>
    </ul>
  </div>
</section>

<section id="ready">
  <h2>😎 Ready!</h2>
</section>